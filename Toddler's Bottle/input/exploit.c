#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <unistd.h>

int main()
{
    //Step 1
    int i;
    char *args[101]={};
    
    for(i=0;i<101;i++)
    {
        args[i]="A";
    }

    args['A'] = "\x00";
    args['B'] = "\x20\x0a\x0d";
    args['C'] = "5001";
    args[100] = NULL;

    //Step 3
    setenv("\xde\xad\xbe\xef", "\xca\xfe\xba\xbe", 1);
    extern char** environ;

    //Step 4
    FILE* fp=fopen("\x0a","w");
    fwrite("\x00\x00\x00\x00",4,1,fp);
    fclose(fp);
    
    //Step 2
    pid_t childpid;
    int pipe_stdin[2];
    int pipe_stderr[2];

    if(pipe(pipe_stderr)<0||pipe(pipe_stdin)<0){
        perror("Could Not Create Pipes\n");
        exit(1);
    }

    if((childpid=fork())<0)
    {
        perror("Fork Error\n");
        exit(2);
    }

    if(childpid==0){
        //Child closes reading side of pipe to prevent arbitrary execution at runtime
        close(pipe_stdin[0]);
        close(pipe_stderr[0]);

        //Write to file descriptor 
        write(pipe_stdin[1], "\x00\x0a\x00\xff", 4);
        write(pipe_stderr[1], "\x00\x0a\x02\xff", 4);
        
        //Step 5
        sleep(3); //Again done to prevent arbitrary execution at runtime 
        int sd;
        struct sockaddr_in saddr;
        sd = socket(AF_INET, SOCK_STREAM, 0);

        if(sd == -1){
        printf("Socket Error,Tell Admin\n");
        return 0;
        }
        
        saddr.sin_family = AF_INET;
        saddr.sin_addr.s_addr = inet_addr("127.0.0.1");
        saddr.sin_port = htons(atoi(args['C']));
        
        if(connect(sd, (struct sockaddr *)&saddr, sizeof(saddr))<0)
        {
        printf("\n Error : Connect Failed \n");
        return 1;
        }
        
        write(sd, "\xde\xad\xbe\xef", 4);
        close(sd);

        return 0;
    }
    else
    {
        //Closing the writing end of pipe
        close(pipe_stdin[1]);
        close(pipe_stderr[1]);

        //Copy the syscalls corresponding to stdin and stderr
        dup2(pipe_stdin[0],0);
        dup2(pipe_stderr[0],2);

        //Close the pipes
        close(pipe_stdin[0]);
        close(pipe_stderr[0]);

        //execute the command
        execve("/home/input2/input", args, environ);
    }

}
